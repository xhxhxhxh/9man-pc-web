(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{113:function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return n}));var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"live-container-student"},[s("div",{staticClass:"alert"},[e.alertVisible?s("a-alert",{attrs:{message:e.alertMessage,type:"success"}}):e._e()],1),e._v(" "),s("main",{ref:"main"},[s("div",{ref:"mainLeft",staticClass:"main-left"},[s("div",{directives:[{name:"show",rawName:"v-show",value:"game"===e.mode,expression:"mode === 'game'"}],staticClass:"courseware-area"},[s("iframe",{ref:"iframe",attrs:{src:e.iframeSrc,allow:"autoplay"}}),e._v(" "),s("iframe",{staticStyle:{display:"none"},attrs:{src:e.iframeSrcCache,allow:"autoplay"}})]),e._v(" "),s("div",{directives:[{name:"show",rawName:"v-show",value:"video"===e.mode,expression:"mode === 'video'"}],ref:"video-area",staticClass:"video-area"},[s("video",{ref:"video-play",attrs:{src:"",preload:"auto"},on:{ended:e.videoEnded}})]),e._v(" "),s("div",{ref:"drawArea",staticClass:"draw-area"},[s("div",{ref:"drawArea",class:{mouseStyle:"FREE_DRAWING"===e.shape},attrs:{id:"tui-image-editor"}})]),e._v(" "),s("div",{ref:"wrapper",staticClass:"wrapper"})]),e._v(" "),s("div",{staticClass:"main-right"},[s("div",{staticClass:"teacher-area"},[s("div",{staticClass:"classroom"},[s("button",{on:{click:e.leaveRoom}},[e._v("离开教室")]),e._v(" "),s("button",[e._v(e._s(e.className+"《"+e.coursewareName+"》"))])]),e._v(" "),s("TeacherVideo",{attrs:{rtcRoom:e.rtcRoom,teacherName:e.teacherName,peerIdList:e.peerIdList,role:"student",stream:e.streamObj[e.teacherId],teacherId:e.teacherId}})],1)]),e._v(" "),s("div",{staticClass:"main-bottom"},[s("div",{staticClass:"students-area"},e._l(e.studentList,(function(t){return s("StudentVideo",{key:t.uid,attrs:{id:t.uid,rtcRoom:e.rtcRoom,studentName:t.uname,stream:e.streamObj[t.uid],info:t,role:"student",studentId:e.studentId}})})),1),e._v(" "),e._m(0)])])])},n=[function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"placeholder"},[t("img",{attrs:{src:s(159),alt:""}})])}];a._withStripped=!0},216:function(e,t){},340:function(e,t,s){"use strict";s.r(t);var a=s(67),n=s.n(a);for(var o in a)"default"!==o&&function(e){s.d(t,e,(function(){return a[e]}))}(o);var r=s(113),i=s(11),c=!1;var d=function(e){c||s(216)},u=Object(i.a)(n.a,r.a,r.b,!1,d,null,null);u.options.__file="src\\views\\live\\LiveForStudent.vue",t.default=u.exports},67:function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});var a=f(s(50)),n=f(s(17)),o=f(s(102)),r=f(s(46)),i=f(s(47)),c=f(s(8));s(161),s(130);var d=f(s(131)),u=f(s(91)),l=f(s(145)),m=f(s(146));function f(e){return e&&e.__esModule?e:{default:e}}var v=s(289),h=c.default.createFromIconfontCN({scriptUrl:"//at.alicdn.com/t/font_1543360_6pq73ac4jna.js"}),p={"menu.normalIcon.path":"/svg/icon-d.svg","menu.activeIcon.path":"/svg/icon-b.svg","menu.disabledIcon.path":"/svg/icon-a.svg","menu.hoverIcon.path":"/svg/icon-c.svg","submenu.normalIcon.path":"/svg/icon-d.svg","submenu.activeIcon.path":"/svg/icon-b.svg"};t.default={name:"Live",data:function(){return{mode:"game",firstLoad:!0,didMounted:!1,didJoinedRoom:!1,alertVisible:!1,alertMessage:"",coursewareResource:[],gameListIndex:[],gameIndex:0,resourceIndex:0,iframeSrc:"",iframeSrcCache:"",coursewareName:"",imageEditor:null,shape:"NORMAL",strokeWidth:6,strokeColor:"#ff0000",lineIdObj:{},rtcRoom:null,peerIdList:[],studentNameObj:{},teacherId:"",studentId:"",studentList:[],studentIdList:[],className:"",roomId:"",teacherName:"",streamObj:{},operating:!1}},components:{IconFont:h,TeacherVideo:l.default,StudentVideo:m.default},computed:{stageStatus:function(){return this.$store.state.liveBroadcast.stageStatusSortByStage}},watch:{stageStatus:function(e){var t=e.length;if(1===t){var s=document.querySelector("#studentVideo"+e[0]),a=this.studentIdList.indexOf(e[0]);s.classList.add("oneStudentOnStage"),s.classList.remove("moreStudentOnStage"),s.style.left=(-513*a+113)/100+"rem",s.style.top="-8rem"}else t>1&&e.forEach((function(e){document.querySelector("#studentVideo"+e).classList.add("moreStudentOnStage")}));if(2===t){var n=document.querySelector("#studentVideo"+e[0]),o=document.querySelector("#studentVideo"+e[1]),r=this.studentIdList.indexOf(e[0]),i=this.studentIdList.indexOf(e[1]);n.style.left=(-513*r+115)/100+"rem",o.style.top=n.style.top="-6.04rem",o.style.left=(-513*i+635)/100+"rem"}if(3===t){var c=document.querySelector("#studentVideo"+e[0]),d=document.querySelector("#studentVideo"+e[1]),u=document.querySelector("#studentVideo"+e[2]),l=this.studentIdList.indexOf(e[0]),m=this.studentIdList.indexOf(e[1]),f=this.studentIdList.indexOf(e[2]);c.style.left=(-513*l+375)/100+"rem",c.style.top="-7.99rem",d.style.top=u.style.top="-4.09rem",d.style.left=(-513*m+115)/100+"rem",u.style.left=(-513*f+635)/100+"rem"}if(4===t){var v=document.querySelector("#studentVideo"+e[0]),h=document.querySelector("#studentVideo"+e[1]),p=document.querySelector("#studentVideo"+e[2]),g=document.querySelector("#studentVideo"+e[3]),I=this.studentIdList.indexOf(e[0]),w=this.studentIdList.indexOf(e[1]),y=this.studentIdList.indexOf(e[2]),S=this.studentIdList.indexOf(e[3]);v.style.left=(-513*I+115)/100+"rem",h.style.left=(-513*w+635)/100+"rem",p.style.left=(-513*y+115)/100+"rem",g.style.left=(-513*S+635)/100+"rem",v.style.top=h.style.top="-7.99rem",p.style.top=g.style.top="-4.09rem"}}},created:function(){this.init()},mounted:function(){this.didMounted=!0,this.initDrawingBoard(),this.stopMouseEventPropagation(),this.didJoinedRoom&&this.getMessage()},methods:{init:function(){var e=this;return(0,i.default)(r.default.mark((function t(){return r.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.$store.commit("readLiveBroadcastDataFromLocalStorage"),e.resize(),t.next=4,e.queryClassInfo();case 4:e.initRtcRoom(),e.getCoursewareInfo(e.$route.params.coursewareId);case 6:case"end":return t.stop()}}),t,e)})))()},resize:function(){var e=this,t=window.innerWidth;document.documentElement.style.fontSize=t/2213*100+"px",this.strokeWidth=parseInt(t/2213*6),window.onresize=function(){var t=window.innerWidth;e.strokeWidth=parseInt(t/2213*6),document.documentElement.style.fontSize=t/2213*100+"px",e.imageEditor.resizeCanvasDimension({width:t/2213*1271,height:t/2213*783})}},initRtcRoom:function(){var e=this,t=u.default.getInstance(),s=this.$route.params.roomId,a=this.$route.params.studentId,r={name:this.$route.params.name,headUrl:"",role:2};this.studentId=a,this.roomId=s;var i=this.teacherId=this.$route.params.teacherId;this.className=this.$route.params.classname,t.on("message-notify-receive",(function(t,s){if(console.log(s),"live_sync"===s.event){var a=s.data;e.resourceIndex=a.sync.page,e.changeAnimate(!0);var n=a.isAllOperate,o=a.operateId;n?(e.setAlert({visiable:!0,message:"你可以操作游戏了"}),e.setPointerEvents(!0)):a.isSingleOperate&&(o===e.studentId?(e.operating=!0,e.setPointerEvents(!0),e.setAlert({visiable:!0,message:"你可以操作游戏了"})):(e.operating=!1,e.setAlert({visiable:!0,message:"学生 "+e.studentNameObj[o]+" 正在操作游戏"})));var r=a.singleVideoArr;e.$nextTick((function(){var e=this;r.forEach((function(t){var s=t,a=document.querySelector("#studentVideo"+s).parentElement;e.$store.commit("setStageStatus",{id:s,status:1}),a.classList.add("onStage")}))}))}})),t.joinRoom("www.9mankid.com",3210,s,a,r),this.rtcRoom=t,this.didJoinedRoom=!0,this.didMounted&&this.getMessage(),t.on("user-joined",(function(s){console.log("用户进入："+s),e.$set(e.streamObj,s,null),s===a&&(t.getAllRoomUser().forEach((function(t){var s=t._peerId;s!==i&&e.peerIdList.push(s)})),t.requestRoomInfo("user_sort",{}),e.studentList.forEach((function(t,a){t.uid===s&&(e.$set(e.studentList[a],"joinRoom",!0),e.$set(e.studentList[a],"isconnect",!0))}))),e.peerIdList.includes(s)||s===i||e.peerIdList.push(s)})),t.on("user-peer-connected",(function(s){console.log("用户连接："+s),s!==e.teacherId&&(t.requestRoomInfo("user_sort",{}),e.studentList.forEach((function(t,a){if(t.uid===s){var n=document.querySelector("#studentVideo"+s).parentElement;e.$set(e.studentList[a],"joinRoom",!0),e.$set(e.studentList[a],"isconnect",!0),n.classList.contains("onStage")&&e.$nextTick((function(){n.classList.add("onStage")}))}})))})),t.on("user-leaved",(function(t){console.log("用户离开："+t,e.peerIdList.indexOf(t));var s=e.peerIdList.indexOf(t);-1!==s&&(e.studentList.forEach((function(s,a){s.uid===t&&e.$set(e.studentList[a],"isconnect",!1)})),e.peerIdList.splice(s,1),e.$store.commit("setPeerIdList",e.peerIdList),e.$store.commit("resetStatus",t),document.querySelector("#studentVideo"+t).style="")})),t.on("media-receive",(function(t,s){e.$set(e.streamObj,t,s)})),t.on("room-info-notify",(function(t,s){var a=s.list,r=a.indexOf(e.teacherId);if(-1!==r&&a.splice(r,1),(0,o.default)(e.studentIdList)!==(0,o.default)(a)){e.studentIdList=a,e.$store.commit("setStudentIdList",a);var i={},c=[].concat((0,n.default)(e.studentList));a.forEach((function(e,t){i[e]=t}));for(var d=0;d<c.length;d++){var u=c[d].uid,l=i[u];if(void 0!==l&&l!==d){var m=[c[l],c[d]];c[d]=m[0],c[l]=m[1],l>d&&d--}}e.studentList=c}})),window.onbeforeunload=function(){t.leaveRoom()}},leaveRoom:function(){var e=this.rtcRoom;this.$confirm({title:"确定要退出房间吗?",content:"",centered:!0,onOk:function(){e.leaveRoom(),localStorage.removeItem("9manLiveBroadcast"),window.close()},onCancel:function(){}})},getCoursewareInfo:function(e){var t=this,s={courseware_no:e};this.$axios.get(this.$store.state.apiUrl+"/v1/courseware/queryCoursewareDetail",{params:s}).then((function(e){var s=e.data;if(200===s.code){t.coursewareName=s.data.data.name,t.coursewareResource=s.data.data.courseware_resource;var a=[];t.coursewareResource.forEach((function(e,t){2===e.type&&a.push(t)})),t.gameListIndex=a,t.changeAnimate(!0)}})).catch((function(){}))},queryClassInfo:function(){var e=this,t={id:this.$route.params.classId};return this.$axios.get(this.$store.state.apiUrl+"/v1/classRoom/queryClassRoomInfo",{params:t}).then((function(t){var s=t.data;if(200===s.code){var a=s.data.data.student_list,n=e.$store.state.liveBroadcast.liveBroadcastData.studentIdList;a.forEach((function(t){e.studentNameObj[t.uid]=t.uname,n.includes(t.uid)?t.joinRoom=!0:t.joinRoom=!1,t.isconnect=!1})),e.studentList=a,e.teacherName=s.data.data.teacher_name}})).catch((function(){}))},initDrawingBoard:function(){var e=this.$refs.mainLeft,t=e.offsetWidth,s=e.offsetHeight,a=new v(document.querySelector("#tui-image-editor"),{includeUI:{loadImage:{path:d.default,name:"SampleImage"},theme:p,initMenu:"filter",menuBarPosition:"bottom"},cssMaxWidth:t,cssMaxHeight:s,selectionStyle:{cornerSize:0,rotatingPointOffset:70,borderColor:"#000"}});this.imageEditor=a},stopMouseEventPropagation:function(){var e=document.querySelector(".live-container-student");e.onmousedown=function(e){e.stopPropagation()},e.onmousemove=function(e){e.stopPropagation()},e.onmouseup=function(e){e.stopPropagation()}},sendEventToIframe:function(){var e=this.$refs.wrapper,t=this.$refs.iframe,s=this;e.onmousedown=function(e){if("game"===s.mode){var a=t.contentWindow.document.querySelector("#gameCanvas"),n={screenX:e.screenX,screenY:e.screenY,clientX:e.layerX,clientY:e.layerY},o=document.createEvent("MouseEvents");o.initMouseEvent("mousedown",!0,!0,document.defaultView,0,n.screenX,n.screenY,n.clientX,n.clientY,!1,!1,!1,!1,0,null),a.dispatchEvent(o),document.onmousemove=function(e){var t={screenX:e.screenX,screenY:e.screenY,clientX:e.layerX,clientY:e.layerY};o.initMouseEvent("mousemove",!0,!0,document.defaultView,0,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),a.dispatchEvent(o)},document.onmouseup=function(e){var t={screenX:e.screenX,screenY:e.screenY,clientX:e.layerX,clientY:e.layerY};o.initMouseEvent("mouseup",!0,!0,document.defaultView,0,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),a.dispatchEvent(o),document.onmousemove=null,document.onmouseup=null}}}},setPointerEvents:function(e){var t=this.$refs.drawArea,s=this.$refs.wrapper;e?(t.style.pointerEvents="none",s.style.pointerEvents="none"):(t.style.pointerEvents="auto",s.style.pointerEvents="auto")},drawByShape:function(){"FREE_DRAWING"===this.shape&&this.drawCurve()},drawCurve:function(){this.imageEditor.startDrawingMode("FREE_DRAWING",{width:this.strokeWidth,color:this.strokeColor})},stopDrawing:function(){var e=this.imageEditor;e.stopDrawingMode(),e.changeCursor("default")},eraser:function(){var e=this.imageEditor;"NORMAL"!==this.shape&&this.stopDrawing(),e.removeActiveObject()},clearAll:function(){var e=this.imageEditor;e.clearObjects(),e._graphics._canvas.deactivateAll(),e._graphics._canvas.renderAll()},changeDrawStatus:function(e){this.shape=e,"FREE_DRAWING"===e?this.drawByShape():"NORMAL"===e?this.stopDrawing():"DELETE"===e&&this.eraser()},setAlert:function(e){this.alertVisible=e.visiable,this.alertMessage=e.message},videoEnded:function(e){e.target.currentTime=0},changeAnimate:function(){var e=this.coursewareResource[this.resourceIndex],t=e.type,s=e.url,a=this.$store.state.resourceUrl;this.gameCache(),1===t?(this.mode="video",this.$nextTick((function(){var e=this.$refs["video-play"];e.src=a+"/"+s,e.pause()})),this.clearAll()):2===t&&(this.mode="game",this.iframeSrc=a+"/"+s+"&roomId="+this.roomId+"&peerId="+this.studentId,this.clearAll())},gameCache:function(){var e=this.$store.state.resourceUrl,t=this.resourceIndex,s=this.gameListIndex,a=this.gameIndex=this.searchInsert(s,t),n=s[a],o=s[a+1];n===t?o&&(this.iframeSrcCache=e+"/"+this.coursewareResource[o].url.replace("start","load")+"&roomId="+this.roomId+"&peerId="+this.teacherId+"&manager=1"):this.iframeSrcCache=e+"/"+this.coursewareResource[n].url.replace("start","load")+"&roomId="+this.roomId+"&peerId="+this.teacherId+"&manager=1"},searchInsert:function(e,t){var s=e.length-1,a=0;if(t>e[s])return 0;if(t<=e[a])return 0;for(;a<=s;){var n=Math.floor((a+s)/2);if(n===a)return a+1;if(t>e[n])a=n;else{if(!(t<e[n]))return n;s=n}}},getMessage:function(){var e=this,t=document.querySelector(".upper-canvas"),s=document.querySelector("#tui-image-editor"),n=(this.$refs.main,this.$refs["video-play"]),o=this.lineIdObj,r=document.createEvent("MouseEvents"),i=null,c=0,d=[];this.rtcRoom.on("message-receive",(function(u){var l=u.event,m=u.data;switch(console.log(u),l){case"show_content_change":e.resourceIndex=m.sync.page,e.changeAnimate();break;case"media_controll":m.isplay?n.play():n.pause();break;case"player_seek_to_value":var f=m.value;n.currentTime=f*n.duration;break;case"add_line":if(i=m.pointlist,e.drawCurve(),o[m.lineId])for(;c<i.length;c++){var v=e.getDrawBoardSize(m,s);r.initMouseEvent("mousemove",!0,!0,document.defaultView,0,0,0,i[c][0]*v.canvasScale-v.scrollLeft,i[c][1]*v.canvasScale-v.scrollTop,!1,!1,!1,!1,0,null),document.dispatchEvent(r)}else{var h=e.getDrawBoardSize(m,s);r.initMouseEvent("mousedown",!0,!0,document.defaultView,0,0,0,i[c][0]*h.canvasScale-h.scrollLeft,i[c][1]*h.canvasScale-h.scrollTop,!1,!1,!1,!1,0,null),t.dispatchEvent(r),o[m.lineId]=!0,c++,e.drawCurve()}if(m.finished){c--;var p=e.getDrawBoardSize(m,s);r.initMouseEvent("mouseup",!0,!0,document.defaultView,0,0,0,i[c][0]*p.canvasScale-p.scrollLeft,i[c][1]*p.canvasScale-p.scrollTop,!1,!1,!1,!1,0,null),document.dispatchEvent(r),c=0;var g=e.imageEditor._graphics._objects,I=(0,a.default)(g);o[m.lineId]=parseInt(I[I.length-1]),e.imageEditor.stopDrawingMode(),e.drawCurve()}break;case"select_line":e.stopDrawing();var w=e.getDrawBoardSize(m,s),y=m.startPoint;r.initMouseEvent(m.action,!0,!0,document.defaultView,0,0,0,y[0]*w.canvasScale-w.scrollLeft,y[1]*w.canvasScale-w.scrollTop,!1,!1,!1,!1,0,null),"mousedown"===m.action?t.dispatchEvent(r):document.dispatchEvent(r);break;case"delete_line":if("web"===m.source)e.imageEditor.removeActiveObject();else{var S=d.length,E=0;!function t(){E<S&&e.imageEditor.removeObject(o[d[E]]).then((function(){E++,t()}))}()}break;case"delete_line_choose_add":d=m.lineIds;break;case"delete_line_choose_cancel":e.imageEditor._graphics._canvas.deactivateAll(),e.imageEditor._graphics._canvas.renderAll();break;case"single_operations":var L=m.peerId;if(!L){e.operating&&(e.$message.warning("你不能再操作游戏了",5),e.operating=!1),e.setPointerEvents(!1),e.setAlert({visiable:!1,message:""});break}L===e.studentId?(e.operating=!0,e.setPointerEvents(!0),e.setAlert({visiable:!0,message:"你可以操作游戏了"})):(e.operating=!1,e.setPointerEvents(!1),e.setAlert({visiable:!0,message:"学生 "+e.studentNameObj[L]+" 正在操作游戏"}));break;case"all_operations":var _=m.operations;e.operating=_,_?(e.setAlert({visiable:!0,message:"你可以操作游戏了"}),e.setPointerEvents(!0)):(e.operating=!1,e.setPointerEvents(!1),e.setAlert({visiable:!1,message:""}),e.$message.warning("你不能再操作游戏了",5));break;case"single_video":var b=m.peerId,R=m.appear,$=document.querySelector("#studentVideo"+b).parentElement;e.$store.commit("setStageStatus",{id:b,status:R?1:2}),R?$.classList.add("onStage"):($.classList.remove("onStage"),$.children[0].style.top="",$.children[0].style.left="");break;case"all_video":var O=m.video;e.studentList.forEach((function(e){if(e.isconnect){var t=e.uid,s=document.querySelector("#studentVideo"+t).parentElement;O?s.classList.add("onStage"):(s.classList.remove("onStage"),s.children[0].style.top="",s.children[0].style.left="")}})),O?e.$store.commit("setStageStatusSortByStage",e.peerIdList):e.$store.commit("setStageStatusSortByStage",[])}}))},getDrawBoardSize:function(e,t){return{scrollLeft:window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0,scrollTop:window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,canvasScale:t.offsetWidth/e.hbsize[0]}}}}}}]);