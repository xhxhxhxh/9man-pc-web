(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{115:function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return r}));var a=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"live-container"},[a("div",{ref:"moveStar",staticClass:"move-star"},[a("img",{staticClass:"star",attrs:{src:s(164),alt:""}})]),e._v(" "),a("div",{directives:[{name:"show",rawName:"v-show",value:e.showAnimateStar,expression:"showAnimateStar"}],ref:"animateStar",staticClass:"animate-star"},[a("img",{staticClass:"star",attrs:{src:e.animateStarSrc,alt:""}})]),e._v(" "),a("div",{staticClass:"alert"},[e.alertVisible?a("a-alert",{attrs:{message:e.alertMessage,type:"success"}}):e._e()],1),e._v(" "),a("main",{ref:"main",staticClass:"clearFix"},[a("div",{ref:"mainLeft",staticClass:"main-left"},[a("div",{directives:[{name:"show",rawName:"v-show",value:"game"===e.mode,expression:"mode === 'game'"}],staticClass:"courseware-area"},[a("iframe",{ref:"iframe",attrs:{src:e.iframeSrc,allow:"autoplay"}}),e._v(" "),a("iframe",{staticStyle:{display:"none"},attrs:{src:e.iframeSrcCache,allow:"autoplay"}})]),e._v(" "),a("div",{directives:[{name:"show",rawName:"v-show",value:"video"===e.mode,expression:"mode === 'video'"}],ref:"video-area",staticClass:"video-area"},[a("video",{ref:"video-play",attrs:{src:"",preload:"auto"},on:{timeupdate:e.videoTimeupdate,ended:e.videoEnded}})]),e._v(" "),a("div",{ref:"drawArea",staticClass:"draw-area"},[a("div",{ref:"drawArea",class:{mouseStyle:"FREE_DRAWING"===e.shape},attrs:{id:"tui-image-editor"}})]),e._v(" "),a("div",{class:{"operate-area":!0,hidden:e.stageStatus.length>0},on:{mousemove:function(e){return e.stopPropagation()}}},[a("div",{class:{default:!0,active:"NORMAL"===e.shape},on:{click:function(t){return e.changeDrawStatus("NORMAL")}}},[a("icon-font",{attrs:{type:"iconuf00db"}})],1),e._v(" "),a("div",{staticClass:"pen",class:{default:!0,active:"FREE_DRAWING"===e.shape},on:{click:function(t){return e.changeDrawStatus("FREE_DRAWING")}}},[a("icon-font",{attrs:{type:"iconpen"}})],1),e._v(" "),a("div",{staticClass:"delete",class:{default:!0,active:"DELETE"===e.shape,drawObjectActive:e.drawObjectActive&&"DELETE"===e.shape},on:{click:function(t){return e.changeDrawStatus("DELETE")}}},[a("icon-font",{attrs:{type:"iconsystem-deleteb"}})],1),e._v(" "),a("div",{staticClass:"previous-page",on:{click:function(t){return e.changeAnimate(t,0)}}},[a("a-tooltip",{attrs:{placement:"right",visible:e.firstPageTip}},[a("template",{slot:"title"},[a("span",[e._v("已经是第一个课件了")])]),e._v(" "),a("a-icon",{attrs:{type:"step-backward"}})],2)],1),e._v(" "),a("div",{staticClass:"next-page",on:{click:function(t){return e.changeAnimate(t,2)}}},[a("a-tooltip",{attrs:{placement:"right",visible:e.lastPageTip}},[a("template",{slot:"title"},[a("span",[e._v("已经是最后一个课件了")])]),e._v(" "),a("a-icon",{attrs:{type:"step-backward"}})],2)],1)]),e._v(" "),a("transition",{attrs:{name:"play-area-slide"}},[a("div",{directives:[{name:"show",rawName:"v-show",value:e.showPlayArea&&"video"===e.mode&&e.stageStatus.length<=0||e.showPlayAreaAlways,expression:"(showPlayArea && mode === 'video' && stageStatus.length <= 0) || showPlayAreaAlways"}],staticClass:"play-area",on:{mouseenter:function(t){e.showPlayAreaAlways=!0},mouseleave:function(t){e.showPlayAreaAlways=!1}}},[a("span",{ref:"play",staticClass:"play",on:{click:e.videoPlay}}),e._v(" "),a("a-slider",{ref:"slider",attrs:{id:"test"},on:{change:e.videoPause,afterChange:e.changeVideoProgress},model:{value:e.progressBar,callback:function(t){e.progressBar=t},expression:"progressBar"}})],1)])],1),e._v(" "),a("div",{staticClass:"main-right"},[a("div",{staticClass:"teacher-area"},[a("div",{staticClass:"classroom"},[a("button",{on:{click:e.leaveRoom}},[e._v("离开教室")]),e._v(" "),a("button",{on:{click:function(){return e.startClassDisabled?e.endClass():e.startClass()}}},[e._v("\n                            "+e._s(e.startClassDisabled?e.remainClassTime+" 结束":"开始")+"上课")])]),e._v(" "),a("TeacherVideo",{attrs:{rtcRoom:e.rtcRoom,teacherName:e.teacherName,peerIdList:e.peerIdList,role:"teacher",stream:e.streamObj[e.teacherId],studentList:e.studentList,teacherConnect:e.teacherConnect},on:{awardAll:e.awardAll,setAlert:e.setAlert}})],1)]),e._v(" "),a("div",{staticClass:"main-bottom"},[a("div",{staticClass:"students-area"},e._l(e.studentList,(function(t){return a("StudentVideo",{key:t.uid,ref:t.uid,refInFor:!0,attrs:{id:t.uid,rtcRoom:e.rtcRoom,studentName:t.uname,stream:e.streamObj[t.uid],info:t,role:"teacher",roleInfo:e.roleInfoObj[t.uid],roomId:e.roomId,allAwardStatus:e.allAwardStatus},on:{setAlert:e.setAlert,addStar:e.addStar,setSingleAwardStatus:e.setSingleAwardStatus}})})),1),e._v(" "),e._m(0)])])])},r=[function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"placeholder"},[t("img",{attrs:{src:s(165),alt:""}})])}];a._withStripped=!0},318:function(e,t){},410:function(e,t,s){"use strict";s.r(t);var a=s(74),r=s.n(a);for(var o in a)"default"!==o&&function(e){s.d(t,e,(function(){return a[e]}))}(o);var n=s(115),i=s(12),c=!1;var d=function(e){c||s(318)},l=Object(i.a)(r.a,n.a,n.b,!1,d,null,null);l.options.__file="src\\views\\live\\LiveForTeacher.vue",t.default=l.exports},74:function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});var a=f(s(52)),r=f(s(120)),o=f(s(102)),n=f(s(47)),i=f(s(48)),c=f(s(8));s(167);var d=f(s(13));s(134);var l=f(s(135)),u=f(s(136)),m=f(s(91)),h=f(s(150)),v=f(s(151));function f(e){return e&&e.__esModule?e:{default:e}}var p=s(319),g=c.default.createFromIconfontCN({scriptUrl:"//at.alicdn.com/t/font_1543360_6pq73ac4jna.js"}),I={"menu.normalIcon.path":"/svg/icon-d.svg","menu.activeIcon.path":"/svg/icon-b.svg","menu.disabledIcon.path":"/svg/icon-a.svg","menu.hoverIcon.path":"/svg/icon-c.svg","submenu.normalIcon.path":"/svg/icon-d.svg","submenu.activeIcon.path":"/svg/icon-b.svg"};t.default={name:"Live",data:function(){return{mode:"game",showPlayArea:!1,showPlayAreaAlways:!1,firstLoad:!0,showAnimateStar:!1,animateStarSrc:u.default,startStarAnimate:!1,alertVisible:!1,alertMessage:"",startClassDisabled:!1,allAwardStatus:!1,singleAwardStatus:!1,noSave:!1,roomInfo:{},remainClassTime:"",coursewareResource:[],gameListIndex:[],gameIndex:0,resourceIndex:0,iframeSrc:"",iframeSrcCache:"",progressBar:0,imageEditor:null,shape:"NORMAL",strokeWidth:6,strokeColor:"#ff0000",drawObjectActive:!1,drawParams:{},drawTimeout:null,lineIdObj:{},rtcRoom:null,peerIdList:[],roleInfoObj:{},teacherId:"",roomId:"",studentList:[],studentIdList:[],studentIdIndexObj:{},teacherName:"",teacherConnect:!1,className:"",streamObj:{},firstPageTip:!1,lastPageTip:!1}},components:{IconFont:g,TeacherVideo:h.default,StudentVideo:v.default},computed:{stageStatus:function(){return this.$store.state.liveBroadcast.stageStatusSortByStage}},watch:{stageStatus:function(e){var t=e.length;if(t>=1){this.changeDrawStatus("NORMAL");var s=this.$refs["video-play"],a=this.$refs.play;s.paused||(s.pause(),a.classList.remove("pause"),this.sendMediaData(0,!1))}if(1===t){var r=document.querySelector("#studentVideo"+e[0]),o=this.studentIdIndexObj[e[0]];r.classList.add("oneStudentOnStage"),r.classList.remove("moreStudentOnStage"),r.style.left=(-513*o+113)/100+"rem",r.style.top="-8rem"}else t>1&&e.forEach((function(e){document.querySelector("#studentVideo"+e).classList.add("moreStudentOnStage")}));if(2===t){var n=document.querySelector("#studentVideo"+e[0]),i=document.querySelector("#studentVideo"+e[1]),c=this.studentIdIndexObj[e[0]],d=this.studentIdIndexObj[e[1]];n.style.left=(-513*c+115)/100+"rem",i.style.top=n.style.top="-6.04rem",i.style.left=(-513*d+635)/100+"rem"}if(3===t){var l=document.querySelector("#studentVideo"+e[0]),u=document.querySelector("#studentVideo"+e[1]),m=document.querySelector("#studentVideo"+e[2]),h=this.studentIdIndexObj[e[0]],v=this.studentIdIndexObj[e[1]],f=this.studentIdIndexObj[e[2]];l.style.left=(-513*h+375)/100+"rem",l.style.top="-7.99rem",u.style.top=m.style.top="-4.09rem",u.style.left=(-513*v+115)/100+"rem",m.style.left=(-513*f+635)/100+"rem"}if(4===t){var p=document.querySelector("#studentVideo"+e[0]),g=document.querySelector("#studentVideo"+e[1]),I=document.querySelector("#studentVideo"+e[2]),w=document.querySelector("#studentVideo"+e[3]),y=this.studentIdIndexObj[e[0]],S=this.studentIdIndexObj[e[1]],_=this.studentIdIndexObj[e[2]],A=this.studentIdIndexObj[e[3]];p.style.left=(-513*y+115)/100+"rem",g.style.left=(-513*S+635)/100+"rem",I.style.left=(-513*_+115)/100+"rem",w.style.left=(-513*A+635)/100+"rem",p.style.top=g.style.top="-7.99rem",I.style.top=w.style.top="-4.09rem"}}},created:function(){this.init()},mounted:function(){this.controlPlayArea(),this.initDrawingBoard()},methods:{init:function(){var e=this;return(0,i.default)(n.default.mark((function t(){return n.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.$store.commit("readLiveBroadcastDataFromLocalStorage",e.$route.params.roomId),e.resize(),t.next=4,e.queryClassInfo();case 4:e.initRtcRoom(),e.recoverPage(),e.getCoursewareInfo(e.$route.params.coursewareId);case 7:case"end":return t.stop()}}),t,e)})))()},resize:function(){var e=this,t=window.innerWidth;document.documentElement.style.fontSize=t/2213*100+"px",this.strokeWidth=parseInt(t/2213*6),window.onresize=function(){var t=window.innerWidth;e.strokeWidth=parseInt(t/2213*6),document.documentElement.style.fontSize=t/2213*100+"px",e.imageEditor.resizeCanvasDimension({width:t/2213*1271,height:t/2213*783})}},controlPlayArea:function(){var e=this,t=this.$refs.mainLeft,s=null,a=null;t.onmouseenter=function(){e.showPlayArea=!0,a&&(clearInterval(a),a=null)},t.onmousemove=function(){e.showPlayArea=!0,s&&(clearInterval(s),s=null),s=setInterval((function(){e.showPlayArea=!1,clearInterval(s),s=null}),2e3)},t.onmouseleave=function(){a||(a=setInterval((function(){e.showPlayArea=!1,clearInterval(a),a=null}),1e3))}},initRtcRoom:function(){var e=this,t=m.default.getInstance(),s=this.$route.params.roomId,a=this.$route.params.teacherId,r={name:this.$route.params.name,headUrl:"",role:1};t.joinRoom("www.9mankid.com",3210,s,a,r),this.teacherId=a,this.roomId=s,this.$store.commit("setTeacherId",a),this.$store.commit("setRoomId",s),this.className=r.classname,t.on("user-joined",(function(s){console.log("用户进入："+s),e.$set(e.streamObj,s,null),s===a&&(t.getAllRoomUser().forEach((function(t){var s=t._peerId;s!==a&&e.peerIdList.push(s)})),e.teacherConnect=!0,t.requestRoomInfo("user_sort",{}),t.requestRoomInfo("room_config",{manager:a}),t.requestRoomInfo("ai_role_info",{})),e.peerIdList.includes(s)||s===a||e.peerIdList.push(s),e.$store.commit("setPeerIdList",e.peerIdList)})),t.on("user-peer-connected",(function(s){if(console.log("用户连接："+s),s!==a){t.requestRoomInfo("user_sort",{}),e.$set(e.studentList[e.studentIdIndexObj[s]],"joinRoom",!0),e.$set(e.studentList[e.studentIdIndexObj[s]],"isconnect",!0);var r=e.$store.state.liveBroadcast.liveBroadcastData.audioStatus[s];r?1===r?t.openAudio(s):2===r&&t.closeAudio(s):(t.openAudio(s),e.$store.commit("setAudioStatus",{id:s,status:1})),e.synchronize(s)}})),t.on("user-leaved",(function(t){console.log("用户离开："+t,e.peerIdList.indexOf(t));var s=e.peerIdList.indexOf(t);if(t!==a?e.$set(e.studentList[e.studentIdIndexObj[t]],"isconnect",!1):e.teacherConnect=!1,-1!==s){var r=e.$store.state.liveBroadcast.liveBroadcastData.allOperation,o=e.$store.getters.updateControlStatus[0];if(!r&&o===t){var n={event:"single_operations",data:{sync:{page:e.resourceIndex,type:0},peerId:""}};e.setAlert({visiable:!1,message:""}),e.rtcRoom.sendMessage(n),e.rtcRoom.changeAIControl(a)}e.peerIdList.splice(s,1),e.$store.commit("setPeerIdList",e.peerIdList),e.$store.commit("resetStatus",t),document.querySelector("#studentVideo"+t).style=""}})),t.on("media-receive",(function(t,s){e.$set(e.streamObj,t,s)})),t.on("ai-action-notify",(function(t,s){var a=s.data,r=s.event;"ai_role"===r?a.available&&e.$set(e.roleInfoObj,a.peerId,{src:a.midpath+a.path}):"ai_role_clear"===r&&(e.roleInfoObj={})})),t.on("room-info-notify",(function(t,s){if("user_sort"===t){var a=s.list;if((0,o.default)(e.studentIdList)===(0,o.default)(a))return;var r={},n={},i=[];e.studentList.forEach((function(e,t){n[e.uid]=t}));for(var c=0;c<a.length;c++){var d=a[c];void 0!==n[d]?(r[d]=c,i[c]=e.studentList[n[d]],delete n[d]):(a.splice(c,1),c--)}var l=a.length;if(l<e.studentList.length)for(var u in n)i[l]=e.studentList[n[u]],r[u]=l,l++;e.studentIdList=a,e.$store.commit("setStudentIdList",a),e.studentList=i,e.studentIdIndexObj=r}else if("ai_role_info"===t){var m=s.list,h={};m.forEach((function(e){var t=e.midpath+e.path;h[e.peerId]={src:t}})),e.roleInfoObj=h}})),window.onbeforeunload=function(){e.rtcRoom.changeAIControl(e.teacherId),e.rtcRoom.changeAISyncStatus(1),"video"!==e.mode||e.noSave||e.$store.commit("setVideoProgress",{index:e.resourceIndex,progress:e.progressBar}),t.leaveRoom()},this.rtcRoom=t,this.$store.commit("setRtcRoom",t)},recoverPage:function(){var e=this.$store.state.liveBroadcast.liveBroadcastData;this.resourceIndex=e.coursewarePage?e.coursewarePage:0},leaveRoom:function(){var e,t=this;this.$confirm({title:"确定要退出房间吗?",content:"",centered:!0,onOk:(e=(0,i.default)(n.default.mark((function e(){var s;return n.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(localStorage.removeItem("9manLiveBroadcast"),t.noSave=!0,0!==t.roomInfo.type){e.next=9;break}return e.next=5,t.clearGameProgress();case 5:(s=e.sent)&&200===s.data.code?window.close():t.$message.error("清除动画进度失败"),e.next=10;break;case 9:window.close();case 10:case"end":return e.stop()}}),e,t)}))),function(){return e.apply(this,arguments)}),onCancel:function(){}})},clearGameProgress:function(){var e={roomId:this.roomInfo.room_no};return this.$axios.get(this.$store.state.emptyRoomUrl+"/emptyRoom",{params:e}).catch((function(){}))},allUsersCancelOperate:function(){if(this.$store.state.liveBroadcast.liveBroadcastData.allOperation)this.$store.commit("setAllOperationStatus",!1);else if(this.$store.getters.updateControlStatus.length>0){var e={event:"single_operations",data:{sync:{page:this.resourceIndex,type:0},peerId:""}};this.setAlert({visiable:!1,message:""}),this.rtcRoom.sendMessage(e),this.rtcRoom.changeAIControl(this.teacherId)}this.$store.commit("updateStageStatusAll",!1)},synchronize:function(e){var t=this.$store.state.liveBroadcast.liveBroadcastData.allOperation,s=this.$store.getters.updateControlStatus,a={event:"live_sync",data:{from:"web",shape:"curve",hbColor:"#ff0000",hbLine:3,isSingleOperate:!!s.length,operateId:s.length?s[0]:"",isAllOperate:t,isAllVideo:!1,isSingleVideo:this.stageStatus.length>0,singleVideoArr:this.stageStatus,sync:{page:this.resourceIndex,type:0}}};if("video"===this.mode){var o=this.$refs["video-play"];(0,r.default)(a.data.sync,{value:this.progressBar/100,isplay:!o.paused})}this.rtcRoom.notifyMessage(a,e)},getCoursewareInfo:function(e){var t=this,s={courseware_no:e};this.$axios.get(this.$store.state.apiUrl+"/v1/courseware/queryCoursewareDetail",{params:s}).then((function(e){var s=e.data;if(200===s.code){t.coursewareResource=s.data.data.courseware_resource;var a=[];t.coursewareResource.forEach((function(e,t){2===e.type&&a.push(t)})),t.gameListIndex=a,t.changeAnimate(t.$event,1,t.firstLoad)}})).catch((function(){}))},queryClassInfo:function(){var e=this,t={id:this.$route.params.classId};return this.$axios.get(this.$store.state.apiUrl+"/v1/classRoom/queryClassRoomInfo",{params:t}).then((function(t){var s=t.data;if(200===s.code){var a=s.data.data.student_list,r=s.data.data.history_list,o={},n=e.$store.state.liveBroadcast.liveBroadcastData.studentIdList;r.forEach((function(e){o[e.uid]=e})),a.forEach((function(t,s){e.studentIdIndexObj[t.uid]=s,t.star=o[t.uid].star,n.includes(t.uid)?t.joinRoom=!0:t.joinRoom=!1,t.isconnect=!1})),e.studentList=a,e.teacherName=s.data.data.teacher_name,e.roomInfo=s.data.data,1===e.roomInfo.status&&(e.startClassDisabled=!0,e.countClassRemainTime())}})).catch((function(){}))},countClassRemainTime:function(){var e=this,t=new Date(this.roomInfo.planendtime).getTime(),s=(new Date).getTime();if(t>s)var a=parseInt((t-s)/1e3),r=setInterval((function(){var t=parseInt(a/60),s=a%60;a--,t=t<10?"0"+t:t,s=s<10?"0"+s:s,e.remainClassTime=t+":"+s,a<0&&clearInterval(r)}),1e3);else this.remainClassTime="00:00"},startClass:function(){var e=this,t={room_no:this.roomId};this.$axios.post(this.$store.state.apiUrl+"/v1/classRoom/updateClassRoomStart",t).then((function(t){var s=t.data;200===s.code?(e.startClassDisabled=!0,e.countClassRemainTime()):403===s.code?e.classWarning():e.$message.warning(s.msg,3)})).catch((function(){}))},endClass:function(){var e=this,t={room_no:this.roomId};this.$axios.post(this.$store.state.apiUrl+"/v1/classRoom/updateClassRoomEnd",t).then((function(t){var s=t.data;200===s.code?e.startClassDisabled=!1:e.$message.warning(s.msg,3)})).catch((function(){}))},classWarning:function(){var e=10,t=this.$warning({title:"上课前5分钟才能开始上课",okText:"我知道了 ("+e+"s)",centered:!0,class:"class-warning"}),s=setInterval((function(){e-=1,t.update({okText:"我知道了 ("+e+"s)"})}),1e3);setTimeout((function(){clearInterval(s),t.destroy()}),1e3*e)},initDrawingBoard:function(){var e=this.$refs.mainLeft,t=e.offsetWidth,s=e.offsetHeight,r=new p(document.querySelector("#tui-image-editor"),{includeUI:{loadImage:{path:l.default,name:"SampleImage"},theme:I,initMenu:"filter",menuBarPosition:"bottom"},cssMaxWidth:t,cssMaxHeight:s,selectionStyle:{cornerSize:0,rotatingPointOffset:0,borderColor:"#000"}});this.imageEditor=r;var o=this,n=document.querySelector("#tui-image-editor");document.querySelector(".upper-canvas");r.on("objectActivated",(function(e){var t=e.id,s=[],a=o.lineIdObj[t];a?s.push(a):r._graphics._canvas._activeGroup._objects.forEach((function(e){s.push(o.lineIdObj[e.__fe_id])}));var n={event:"delete_line_choose_add",data:{lineIds:s,source:"web",sync:{page:o.resourceIndex,type:0}}};o.rtcRoom.sendMessage(n)})),n.onmousedown=function(t){var s=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0,i=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,c=e.getBoundingClientRect(),l=c.left,u=c.top,m=[t.clientX+s-l,t.clientY+i-u];if("FREE_DRAWING"===o.shape){var h=r._graphics._canvas._activeGroup,v=r._graphics._objects,f=(0,a.default)(v),p=(Array(7).join("0")+f.length).slice(-7),g=(0,d.default)().format("HHmmssSSS")+p;h&&(r._graphics._canvas.deactivateAll(),r._graphics._canvas.renderAll()),o.drawParams={event:"add_line",data:{sync:{page:o.resourceIndex,type:0},lineId:g,shape:"curve",hbsize:[n.offsetWidth,n.offsetHeight],line:o.strokeWidth,color:o.strokeColor,pointlist:[m]}},o.drawByShape(),o.sendDrawData(),document.onmousemove=function(e){o.drawParams.data.pointlist.push([e.clientX+s-l,e.clientY+i-u]),o.sendDrawData()}}if("DELETE"===o.shape){var I={event:"select_line",data:{action:"mousedown",hbsize:[n.offsetWidth,n.offsetHeight],startPoint:[t.clientX+s,t.clientY+i],sync:{page:o.resourceIndex,type:0}}};if(o.rtcRoom.sendMessage(I),!r._graphics._canvas.findTarget(t)){var w={event:"delete_line_choose_cancel",data:{source:"web",sync:{page:o.resourceIndex,type:0}}};o.rtcRoom.sendMessage(w)}document.onmousemove=function(e){var t={event:"select_line",data:{action:"mousemove",hbsize:[n.offsetWidth,n.offsetHeight],startPoint:[e.clientX+s,e.clientY+i],sync:{page:o.resourceIndex,type:0}}};o.rtcRoom.sendMessage(t)}}document.onmouseup=function(e){if("FREE_DRAWING"===o.shape){var t=r._graphics._objects,c=(0,a.default)(t),d=parseInt(c[c.length-1]);r.setObjectProperties(d,{lockMovementX:!0,lockMovementY:!0,lockScalingX:!0,lockScalingY:!0,lockRotation:!0}),o.lineIdObj[d]=g,o.drawParams.data.pointlist.push([e.clientX+s-l,e.clientY+i-u]),o.drawParams.data.finished=1,o.sendDrawData(),r.stopDrawingMode(),o.drawByShape(),document.onmousemove=null}if("DELETE"===o.shape){var m=r.activeObjectId;!m&&o.drawObjectActive?o.drawObjectActive=!1:m&&!o.drawObjectActive&&(o.drawObjectActive=!0);var h={event:"select_line",data:{action:"mouseup",hbsize:[n.offsetWidth,n.offsetHeight],startPoint:[e.clientX+s,e.clientY+i],sync:{page:o.resourceIndex,type:0}}};o.rtcRoom.sendMessage(h),document.onmousemove=null}document.onmouseup=null}}},sendEventToIframe:function(){var e=this.$refs.wrapper,t=this.$refs.iframe,s=this;e.onmousedown=function(e){if("game"===s.mode){var a=t.contentWindow.document.querySelector("#gameCanvas"),r={screenX:e.screenX,screenY:e.screenY,clientX:e.layerX,clientY:e.layerY},o=document.createEvent("MouseEvents");o.initMouseEvent("mousedown",!0,!0,document.defaultView,0,r.screenX,r.screenY,r.clientX,r.clientY,!1,!1,!1,!1,0,null),a.dispatchEvent(o),document.onmousemove=function(e){var t={screenX:e.screenX,screenY:e.screenY,clientX:e.layerX,clientY:e.layerY};o.initMouseEvent("mousemove",!0,!0,document.defaultView,0,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),a.dispatchEvent(o)},document.onmouseup=function(e){var t={screenX:e.screenX,screenY:e.screenY,clientX:e.layerX,clientY:e.layerY};o.initMouseEvent("mouseup",!0,!0,document.defaultView,0,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),a.dispatchEvent(o),document.onmousemove=null,document.onmouseup=null}}}},drawByShape:function(){"FREE_DRAWING"===this.shape&&this.drawCurve()},drawCurve:function(){this.imageEditor.startDrawingMode("FREE_DRAWING",{width:this.strokeWidth,color:this.strokeColor})},stopDrawing:function(){var e=this.imageEditor;e.stopDrawingMode(),e.changeCursor("default")},eraser:function(){var e=this.imageEditor;e.activeObjectId;"NORMAL"!==this.shape&&this.stopDrawing(),e.removeActiveObject(),this.drawObjectActive=!1;var t={event:"delete_line",data:{source:"web",sync:{page:this.resourceIndex}}};this.rtcRoom.sendMessage(t)},clearAll:function(){var e=this.imageEditor;e.clearObjects(),this.drawObjectActive=!1,e._graphics._canvas.deactivateAll(),e._graphics._canvas.renderAll()},sendDrawData:function(){var e=this;this.drawTimeout||(this.drawTimeout=setInterval((function(){e.rtcRoom.sendMessage(e.drawParams),clearInterval(e.drawTimeout),e.drawTimeout=null}),100))},changeDrawStatus:function(e){this.shape=e;var t=this.$refs.drawArea;"FREE_DRAWING"===e?(t.style.pointerEvents="auto",this.drawByShape()):"NORMAL"===e?(t.style.pointerEvents="none",this.stopDrawing()):"DELETE"===e&&(t.style.pointerEvents="auto",this.eraser())},videoPlay:function(){if("video"===this.mode){var e=this.$refs["video-play"],t=this.$refs.play;e.paused?(e.play(),t.classList.add("pause"),this.sendMediaData(0,!0)):(e.pause(),t.classList.remove("pause"),this.sendMediaData(0,!1))}},videoTimeupdate:function(e){var t=e.target,s=t.currentTime;t.paused||(this.progressBar=parseInt(s/t.duration*100))},changeVideoProgress:function(e){var t=this.$refs["video-play"],s=this.$refs.play;this.sendMediaData(0,!t.paused,e/100),s.classList.contains("pause")&&(t.play(),this.sendMediaData(0,!0)),t.currentTime=e/100*t.duration},videoPause:function(){var e=this.$refs["video-play"];e.paused||e.pause()},videoEnded:function(e){var t=e.target,s=this.$refs.play;t.currentTime=0,this.progressBar=0,s.classList.remove("pause")},sendMediaData:function(e,t,s){var a={};a=s||0===s?{event:"player_seek_to_value",data:{value:s,sync:{type:0,value:s,page:this.resourceIndex}}}:{event:"media_controll",data:{isplay:t,source:"fromweb",sync:{type:0,value:this.progressBar/100,page:this.resourceIndex}}},this.rtcRoom.sendMessage(a)},setAlert:function(e){this.alertVisible=e.visiable,this.alertMessage=e.message},changeAnimate:function(e,t,s){var a=this;if(this.$store.state.liveBroadcast.liveBroadcastData.allOperation)return this.$message.warning("请先关闭全部授权",5);if(this.$store.getters.updateControlStatus)return this.$message.warning("请先关闭单人授权",5);this.changeDrawStatus("NORMAL");var r=this.coursewareResource.length-1,o=this.resourceIndex;if(s||this.$store.commit("setVideoProgress",{index:o,progress:this.progressBar,noSave:!0}),2===t){if(o>=r&&!s)return this.lastPageTip=!0,void setTimeout((function(){a.lastPageTip=!1}),2e3);this.clearAll(),this.resourceIndex++}else if(0===t){if(o<=0&&!s)return this.firstPageTip=!0,void setTimeout((function(){a.firstPageTip=!1}),2e3);this.clearAll(),this.resourceIndex--}var n=this.coursewareResource[this.resourceIndex],i=n.type,c=n.url,d=this.$store.state.resourceUrl;this.gameCache();var l=this.$refs["video-play"];if(l.pause(),1===i){this.$store.commit("setOperatePermission",!1),this.mode="video",l.src=d+"/"+c,this.$refs.play.classList.remove("pause");var u=this.$store.state.liveBroadcast.liveBroadcastData.videoProgress[this.resourceIndex];this.progressBar=u||0,l.oncanplay=function(){l.oncanplay=null,l.currentTime=a.progressBar/100*l.duration}}else 2===i&&(this.$store.commit("setOperatePermission",!0),this.mode="game",this.iframeSrc=d+"/"+c+"&roomId="+this.roomId+"&peerId="+this.teacherId+"&manager=1");this.sendMediaData("video"===this.mode?1:0,!1);var m={event:"show_content_change",data:{page:this.resourceIndex,type:0,sync:{page:this.resourceIndex,value:this.progressBar/100}}};this.$store.commit("setCoursewarePage",this.resourceIndex),s||this.rtcRoom.sendMessage(m)},gameCache:function(){var e=this.$store.state.resourceUrl,t=this.resourceIndex,s=this.gameListIndex,a=this.gameIndex=this.searchInsert(s,t),r=s[a],o=s[a+1];r===t?o&&(this.iframeSrcCache=e+"/"+this.coursewareResource[o].url.replace("start","load")+"&roomId="+this.roomId+"&peerId="+this.teacherId+"&manager=1"):this.iframeSrcCache=e+"/"+this.coursewareResource[r].url.replace("start","load")+"&roomId="+this.roomId+"&peerId="+this.teacherId+"&manager=1"},searchInsert:function(e,t){var s=e.length-1,a=0;if(t>e[s])return 0;if(t<=e[a])return 0;for(;a<=s;){var r=Math.floor((a+s)/2);if(r===a)return a+1;if(t>e[r])a=r;else{if(!(t<e[r]))return r;s=r}}},addStar:function(e){var t=e.id,s=e.star+1;this.$set(this.studentList[this.studentIdIndexObj[t]],"star",s)},awardAll:function(){var e=this;this.peerIdList.length<=0||(this.allAwardStatus||this.singleAwardStatus?this.$message.warning("请稍后再试",3):(this.allAwardStatus=!0,this.$axios.post(this.$store.state.apiUrl+"/v1/classRoomHistory/addClassRoomReward",{room_no:this.roomId,students:this.peerIdList.toString()}).then((function(t){var s=t.data;if(200===s.code){var a={event:"all_award",data:{sync:{page:e.resourceIndex}}};e.rtcRoom.sendMessage(a),e.peerIdList.forEach((function(t){e.$refs[t][0].starAnimate()})),setTimeout((function(){e.allAwardStatus=!1}),2800)}else e.$message.warning(s.msg),e.allAwardStatus=!1})).catch((function(){e.allAwardStatus=!1}))))},setSingleAwardStatus:function(e){this.singleAwardStatus=e}}}}}]);